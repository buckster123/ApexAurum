<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village GUI - Apex Aurum</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <a href="/" class="back-link">â—‚ Back to Chat</a>

    <div class="village-layout">
        <!-- Left Panel: Agent Selection & Controls -->
        <aside class="control-panel">
            <div class="panel-section">
                <h3>âš— Agent</h3>
                <select id="agent-select">
                    <option value="CLAUDE" data-color="#00aaff">CLAUDE (Default)</option>
                    <option value="AZOTH" data-color="#00ffaa">âˆ´AZOTHâˆ´</option>
                    <option value="ELYSIAN" data-color="#ff69b4">âˆ´ELYSIANâˆ´</option>
                    <option value="VAJRA" data-color="#ffd700">âˆ´VAJRAâˆ´</option>
                    <option value="KETHER" data-color="#9370db">âˆ´KETHERâˆ´</option>
                </select>
            </div>

            <div class="panel-section">
                <h3>ğŸ›  Quick Tools</h3>
                <div class="tool-buttons">
                    <button onclick="triggerTool('memory_list', {})" class="tool-btn memory">
                        ğŸŒ¿ Memory
                    </button>
                    <button onclick="triggerTool('fs_list_files', {path: '.'})" class="tool-btn files">
                        ğŸ“ Files
                    </button>
                    <button onclick="triggerTool('get_current_time', {format: 'human'})" class="tool-btn time">
                        â° Time
                    </button>
                    <button onclick="triggerTool('agent_list', {})" class="tool-btn agents">
                        ğŸŒ‰ Agents
                    </button>
                    <button onclick="triggerTool('execute_python', {code: 'print(\"Hello Village!\")'})" class="tool-btn code">
                        âš™ï¸ Code
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3>ğŸŒ… Time Control</h3>
                <div class="time-controls">
                    <button onclick="setVillageTime(6)" class="time-btn dawn">ğŸŒ… Dawn</button>
                    <button onclick="setVillageTime(12)" class="time-btn day">â˜€ï¸ Noon</button>
                    <button onclick="setVillageTime(18)" class="time-btn dusk">ğŸŒ‡ Dusk</button>
                    <button onclick="setVillageTime(0)" class="time-btn night">ğŸŒ™ Night</button>
                    <button onclick="useRealTime()" class="time-btn real">â° Real</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>ğŸŒ¤ï¸ Weather</h3>
                <div class="weather-controls">
                    <button onclick="setWeather('clear')" class="weather-btn clear">â˜€ï¸</button>
                    <button onclick="setWeather('rain')" class="weather-btn rain">ğŸŒ§ï¸</button>
                    <button onclick="setWeather('storm')" class="weather-btn storm">â›ˆï¸</button>
                    <button onclick="setWeather('snow')" class="weather-btn snow">â„ï¸</button>
                    <button onclick="setWeather('fog')" class="weather-btn fog">ğŸŒ«ï¸</button>
                </div>
                <div class="intensity-control">
                    <label>Intensity:</label>
                    <input type="range" id="weather-intensity" min="0" max="100" value="50"
                           onchange="updateWeatherIntensity(this.value)">
                </div>
            </div>

            <div class="panel-section">
                <h3>ğŸ˜Š Mood</h3>
                <div class="mood-controls">
                    <button onclick="setMood('happy')" class="mood-btn happy">ğŸ˜Š</button>
                    <button onclick="setMood('stressed')" class="mood-btn stressed">ğŸ˜°</button>
                    <button onclick="setMood('thinking')" class="mood-btn thinking">ğŸ’­</button>
                    <button onclick="setMood('energized')" class="mood-btn energized">âš¡</button>
                    <button onclick="setMood('idle')" class="mood-btn idle">ğŸ˜´</button>
                </div>
                <div class="mood-sim">
                    <button onclick="simulateResult(true)" class="sim-btn success">âœ“ Success</button>
                    <button onclick="simulateResult(false)" class="sim-btn fail">âœ— Fail</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>ğŸ“Š Stats</h3>
                <div id="stats-panel">
                    <div class="stat-row">
                        <span class="stat-label">Status:</span>
                        <span id="stat-connection" class="stat-value disconnected">â—</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Events:</span>
                        <span id="stat-events" class="stat-value">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Last Tool:</span>
                        <span id="stat-last-tool" class="stat-value">-</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center: Canvas -->
        <main class="canvas-container">
            <canvas id="village-canvas"></canvas>
            <!-- Zone detail popup (shown on zone click) -->
            <div id="zone-detail-panel" class="zone-detail-panel">
                <!-- Populated by JavaScript -->
            </div>
        </main>

        <!-- Right Panel: Activity Log -->
        <aside class="activity-panel">
            <div class="panel-header">
                <h3>ğŸ“œ Activity Log</h3>
                <button onclick="clearLog()" class="clear-btn" title="Clear log">âœ•</button>
            </div>
            <div id="activity-log">
                <div class="log-entry system">Waiting for events...</div>
            </div>
        </aside>
    </div>

    <script>
        // Global reference for village app (set by village.js)
        window.villageApp = null;

        // Trigger a tool and update UI
        async function triggerTool(tool, args) {
            const btn = event.target;
            btn.disabled = true;
            btn.classList.add('loading');

            try {
                const res = await fetch('/api/tools/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tool, arguments: args})
                });
                const data = await res.json();
                console.log('Tool result:', data);
            } catch(e) {
                console.error('Tool error:', e);
                addLogEntry('error', 'SYSTEM', tool, 'Request failed');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        // Time control functions
        function setVillageTime(hour) {
            if (window.villageApp) {
                window.villageApp.setTime(hour);
                addLogEntry('system', 'SYSTEM', 'time', `Set to ${hour}:00`);
            }
        }

        function useRealTime() {
            if (window.villageApp && window.villageApp.renderer) {
                window.villageApp.renderer.useRealTimeMode();
                addLogEntry('system', 'SYSTEM', 'time', 'Using real time');
            }
        }

        // Weather control functions
        let currentWeather = 'clear';
        let weatherIntensity = 0.5;

        function setWeather(type) {
            currentWeather = type;
            if (window.villageApp) {
                window.villageApp.setWeather(type, weatherIntensity);
                const icons = {clear: 'â˜€ï¸', rain: 'ğŸŒ§ï¸', storm: 'â›ˆï¸', snow: 'â„ï¸', fog: 'ğŸŒ«ï¸'};
                addLogEntry('system', 'SYSTEM', 'weather', `${icons[type]} ${type}`);
            }
        }

        function updateWeatherIntensity(value) {
            weatherIntensity = value / 100;
            if (window.villageApp) {
                window.villageApp.setWeather(currentWeather, weatherIntensity);
            }
        }

        // Mood control functions
        function setMood(mood) {
            if (window.villageApp) {
                window.villageApp.setMood(mood);
                const icons = {happy: 'ğŸ˜Š', stressed: 'ğŸ˜°', thinking: 'ğŸ’­', energized: 'âš¡', idle: 'ğŸ˜´'};
                addLogEntry('system', 'SYSTEM', 'mood', `${icons[mood]} ${mood}`);
            }
        }

        function simulateResult(success) {
            if (window.villageApp) {
                window.villageApp.simulateResult(success);
                addLogEntry('system', 'SYSTEM', 'test', success ? 'âœ“ Success recorded' : 'âœ— Failure recorded');
            }
        }

        // Add entry to activity log
        function addLogEntry(type, agent, tool, detail, zone = null) {
            const log = document.getElementById('activity-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            const icon = type === 'start' ? 'â†’' : type === 'complete' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â€¢';
            const zoneText = zone ? ` @ ${zone}` : '';

            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-icon">${icon}</span>
                <span class="log-agent">${agent}</span>
                <span class="log-tool">${tool}</span>
                <span class="log-zone">${zoneText}</span>
            `;

            // Remove "waiting" message if present
            const waiting = log.querySelector('.system');
            if (waiting) waiting.remove();

            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;

            // Flash effect
            entry.classList.add('flash');
            setTimeout(() => entry.classList.remove('flash'), 500);
        }

        // Clear activity log
        function clearLog() {
            const log = document.getElementById('activity-log');
            log.innerHTML = '<div class="log-entry system">Log cleared</div>';
        }

        // Update stats display
        function updateStats(stats) {
            const conn = document.getElementById('stat-connection');
            conn.textContent = stats.connection === 'connected' ? 'â— Connected' : 'â—‹ Disconnected';
            conn.className = 'stat-value ' + stats.connection;

            document.getElementById('stat-events').textContent = stats.eventCount;
            document.getElementById('stat-last-tool').textContent = stats.lastTool || '-';
        }

        // Agent selector change
        document.getElementById('agent-select').addEventListener('change', function() {
            const agentId = this.value;
            console.log('Switched to agent:', agentId);
            // Notify village app
            if (window.villageApp) {
                window.villageApp.setCurrentAgent(agentId);
            }
            // Store preference
            localStorage.setItem('village_agent', agentId);
        });

        // Restore agent preference
        const savedAgent = localStorage.getItem('village_agent');
        if (savedAgent) {
            document.getElementById('agent-select').value = savedAgent;
        }
    </script>
    <script type="module" src="village.js"></script>
    <script>
        // Debug: Check if JS modules load correctly
        window.addEventListener('error', function(e) {
            console.error('JS Error:', e.message, e.filename, e.lineno);
            document.getElementById('stat-connection').textContent = 'JS ERROR: ' + e.message;
        });
        // Mark that inline script ran
        console.log('Village GUI: Inline scripts loaded');
    </script>
</body>
</html>
