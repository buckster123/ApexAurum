<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village GUI - Apex Aurum</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <a href="/" class="back-link">‚óÇ Back to Chat</a>

    <div class="village-layout">
        <!-- Left Panel: Agent Selection & Controls -->
        <aside class="control-panel">
            <div class="panel-section">
                <h3>‚öó Agent</h3>
                <select id="agent-select">
                    <option value="CLAUDE" data-color="#00aaff">CLAUDE (Default)</option>
                    <option value="AZOTH" data-color="#00ffaa">‚à¥AZOTH‚à¥</option>
                    <option value="ELYSIAN" data-color="#ff69b4">‚à¥ELYSIAN‚à¥</option>
                    <option value="VAJRA" data-color="#ffd700">‚à¥VAJRA‚à¥</option>
                    <option value="KETHER" data-color="#9370db">‚à¥KETHER‚à¥</option>
                </select>
            </div>

            <div class="panel-section">
                <h3>üõ† Quick Tools</h3>
                <div class="tool-buttons">
                    <button onclick="triggerTool('memory_list', {})" class="tool-btn memory">
                        üåø Memory
                    </button>
                    <button onclick="triggerTool('fs_list_files', {path: '.'})" class="tool-btn files">
                        üìÅ Files
                    </button>
                    <button onclick="triggerTool('get_current_time', {format: 'human'})" class="tool-btn time">
                        ‚è∞ Time
                    </button>
                    <button onclick="triggerTool('agent_list', {})" class="tool-btn agents">
                        üåâ Agents
                    </button>
                    <button onclick="triggerTool('execute_python', {code: 'print(\"Hello Village!\")'})" class="tool-btn code">
                        ‚öôÔ∏è Code
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3>üåÖ Time Control</h3>
                <div class="time-controls">
                    <button onclick="setVillageTime(6)" class="time-btn dawn">üåÖ Dawn</button>
                    <button onclick="setVillageTime(12)" class="time-btn day">‚òÄÔ∏è Noon</button>
                    <button onclick="setVillageTime(18)" class="time-btn dusk">üåá Dusk</button>
                    <button onclick="setVillageTime(0)" class="time-btn night">üåô Night</button>
                    <button onclick="useRealTime()" class="time-btn real">‚è∞ Real</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>üå§Ô∏è Weather</h3>
                <div class="weather-controls">
                    <button onclick="setWeather('clear')" class="weather-btn clear">‚òÄÔ∏è</button>
                    <button onclick="setWeather('rain')" class="weather-btn rain">üåßÔ∏è</button>
                    <button onclick="setWeather('storm')" class="weather-btn storm">‚õàÔ∏è</button>
                    <button onclick="setWeather('snow')" class="weather-btn snow">‚ùÑÔ∏è</button>
                    <button onclick="setWeather('fog')" class="weather-btn fog">üå´Ô∏è</button>
                </div>
                <div class="intensity-control">
                    <label>Intensity:</label>
                    <input type="range" id="weather-intensity" min="0" max="100" value="50"
                           onchange="updateWeatherIntensity(this.value)">
                </div>
            </div>

            <div class="panel-section">
                <h3>üòä Mood</h3>
                <div class="mood-controls">
                    <button onclick="setMood('happy')" class="mood-btn happy">üòä</button>
                    <button onclick="setMood('stressed')" class="mood-btn stressed">üò∞</button>
                    <button onclick="setMood('thinking')" class="mood-btn thinking">üí≠</button>
                    <button onclick="setMood('energized')" class="mood-btn energized">‚ö°</button>
                    <button onclick="setMood('idle')" class="mood-btn idle">üò¥</button>
                </div>
                <div class="mood-sim">
                    <button onclick="simulateResult(true)" class="sim-btn success">‚úì Success</button>
                    <button onclick="simulateResult(false)" class="sim-btn fail">‚úó Fail</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>üìä Stats</h3>
                <div id="stats-panel">
                    <div class="stat-row">
                        <span class="stat-label">Status:</span>
                        <span id="stat-connection" class="stat-value disconnected">‚óè</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Events:</span>
                        <span id="stat-events" class="stat-value">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Last Tool:</span>
                        <span id="stat-last-tool" class="stat-value">-</span>
                    </div>
                </div>
            </div>

            <div class="panel-section dj-booth-section">
                <h3>üéµ DJ Booth</h3>
                <div class="dj-controls">
                    <div class="dj-preset-row">
                        <select id="dj-preset-select">
                            <option value="">Select Preset...</option>
                        </select>
                        <button onclick="loadDJPresets()" class="dj-btn refresh" title="Refresh presets">‚Üª</button>
                    </div>
                    <div class="dj-intent-row">
                        <input type="text" id="dj-intent" placeholder="Describe the sound..." />
                    </div>
                    <div class="dj-options-row">
                        <select id="dj-mood">
                            <option value="mystical">Mystical</option>
                            <option value="ethereal">Ethereal</option>
                            <option value="dark">Dark</option>
                            <option value="triumphant">Triumphant</option>
                            <option value="playful">Playful</option>
                            <option value="melancholic">Melancholic</option>
                            <option value="error">Error/Glitch</option>
                        </select>
                        <select id="dj-purpose">
                            <option value="sfx">SFX (5-30s)</option>
                            <option value="ambient">Ambient (1-4m)</option>
                            <option value="loop">Loop (15-60s)</option>
                            <option value="jingle">Jingle (15-45s)</option>
                            <option value="song">Full Song</option>
                        </select>
                    </div>
                    <div class="dj-sliders-row">
                        <div class="dj-slider">
                            <label>Weird</label>
                            <input type="range" id="dj-weirdness" min="0" max="100" value="30">
                        </div>
                        <div class="dj-slider">
                            <label>Style</label>
                            <input type="range" id="dj-style" min="0" max="100" value="70">
                        </div>
                    </div>
                    <div class="dj-buttons-row">
                        <button onclick="compilePrompt()" class="dj-btn compile">üîÆ Compile</button>
                        <button onclick="generateMusic()" class="dj-btn generate" id="dj-generate-btn">üéπ Generate</button>
                    </div>
                    <div class="dj-status" id="dj-status">Ready</div>
                    <div class="dj-preview" id="dj-preview" style="display: none;">
                        <div class="dj-preview-text" id="dj-preview-text"></div>
                    </div>
                </div>
                <div class="dj-audio" id="dj-audio-container" style="display: none;">
                    <audio id="dj-audio-player" controls></audio>
                    <div class="dj-audio-controls">
                        <button onclick="editAudio('trim')" class="dj-btn mini">‚úÇÔ∏è Trim</button>
                        <button onclick="editAudio('fade')" class="dj-btn mini">üìâ Fade</button>
                        <button onclick="editAudio('normalize')" class="dj-btn mini">üìä Norm</button>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3>üîä Sound</h3>
                <div class="sound-controls">
                    <div class="sound-row">
                        <label>Master</label>
                        <input type="range" id="sound-master" min="0" max="100" value="70"
                               onchange="updateVolume('master', this.value)">
                        <button onclick="toggleMute()" id="mute-btn" class="sound-btn">üîä</button>
                    </div>
                    <div class="sound-row">
                        <label>UI</label>
                        <input type="range" id="sound-ui" min="0" max="100" value="100"
                               onchange="updateVolume('ui', this.value)">
                    </div>
                    <div class="sound-row">
                        <label>Ambient</label>
                        <input type="range" id="sound-ambient" min="0" max="100" value="50"
                               onchange="updateVolume('ambient', this.value)">
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center: Canvas -->
        <main class="canvas-container">
            <canvas id="village-canvas"></canvas>
            <!-- Zone detail popup (shown on zone click) -->
            <div id="zone-detail-panel" class="zone-detail-panel">
                <!-- Populated by JavaScript -->
            </div>
        </main>

        <!-- Right Panel: Activity Log -->
        <aside class="activity-panel">
            <div class="panel-header">
                <h3>üìú Activity Log</h3>
                <button onclick="clearLog()" class="clear-btn" title="Clear log">‚úï</button>
            </div>
            <div id="activity-log">
                <div class="log-entry system">Waiting for events...</div>
            </div>
        </aside>
    </div>

    <script>
        // Global reference for village app (set by village.js)
        window.villageApp = null;

        // Trigger a tool and update UI
        async function triggerTool(tool, args) {
            const btn = event.target;
            btn.disabled = true;
            btn.classList.add('loading');

            try {
                const res = await fetch('/api/tools/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tool, arguments: args})
                });
                const data = await res.json();
                console.log('Tool result:', data);
            } catch(e) {
                console.error('Tool error:', e);
                addLogEntry('error', 'SYSTEM', tool, 'Request failed');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        // Time control functions
        function setVillageTime(hour) {
            if (window.villageApp) {
                window.villageApp.setTime(hour);
                addLogEntry('system', 'SYSTEM', 'time', `Set to ${hour}:00`);
            }
        }

        function useRealTime() {
            if (window.villageApp && window.villageApp.renderer) {
                window.villageApp.renderer.useRealTimeMode();
                addLogEntry('system', 'SYSTEM', 'time', 'Using real time');
            }
        }

        // Weather control functions
        let currentWeather = 'clear';
        let weatherIntensity = 0.5;

        function setWeather(type) {
            currentWeather = type;
            if (window.villageApp) {
                window.villageApp.setWeather(type, weatherIntensity);
                const icons = {clear: '‚òÄÔ∏è', rain: 'üåßÔ∏è', storm: '‚õàÔ∏è', snow: '‚ùÑÔ∏è', fog: 'üå´Ô∏è'};
                addLogEntry('system', 'SYSTEM', 'weather', `${icons[type]} ${type}`);
            }
        }

        function updateWeatherIntensity(value) {
            weatherIntensity = value / 100;
            if (window.villageApp) {
                window.villageApp.setWeather(currentWeather, weatherIntensity);
            }
        }

        // Mood control functions
        function setMood(mood) {
            if (window.villageApp) {
                window.villageApp.setMood(mood);
                const icons = {happy: 'üòä', stressed: 'üò∞', thinking: 'üí≠', energized: '‚ö°', idle: 'üò¥'};
                addLogEntry('system', 'SYSTEM', 'mood', `${icons[mood]} ${mood}`);
            }
        }

        function simulateResult(success) {
            if (window.villageApp) {
                window.villageApp.simulateResult(success);
                addLogEntry('system', 'SYSTEM', 'test', success ? '‚úì Success recorded' : '‚úó Failure recorded');
            }
        }

        // Add entry to activity log
        function addLogEntry(type, agent, tool, detail, zone = null) {
            const log = document.getElementById('activity-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            const icon = type === 'start' ? '‚Üí' : type === 'complete' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ä¢';
            const zoneText = zone ? ` @ ${zone}` : '';

            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-icon">${icon}</span>
                <span class="log-agent">${agent}</span>
                <span class="log-tool">${tool}</span>
                <span class="log-zone">${zoneText}</span>
            `;

            // Remove "waiting" message if present
            const waiting = log.querySelector('.system');
            if (waiting) waiting.remove();

            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;

            // Flash effect
            entry.classList.add('flash');
            setTimeout(() => entry.classList.remove('flash'), 500);
        }

        // Clear activity log
        function clearLog() {
            const log = document.getElementById('activity-log');
            log.innerHTML = '<div class="log-entry system">Log cleared</div>';
        }

        // Update stats display
        function updateStats(stats) {
            const conn = document.getElementById('stat-connection');
            conn.textContent = stats.connection === 'connected' ? '‚óè Connected' : '‚óã Disconnected';
            conn.className = 'stat-value ' + stats.connection;

            document.getElementById('stat-events').textContent = stats.eventCount;
            document.getElementById('stat-last-tool').textContent = stats.lastTool || '-';
        }

        // Agent selector change
        document.getElementById('agent-select').addEventListener('change', function() {
            const agentId = this.value;
            console.log('Switched to agent:', agentId);
            // Notify village app
            if (window.villageApp) {
                window.villageApp.setCurrentAgent(agentId);
            }
            // Store preference
            localStorage.setItem('village_agent', agentId);
        });

        // Restore agent preference
        const savedAgent = localStorage.getItem('village_agent');
        if (savedAgent) {
            document.getElementById('agent-select').value = savedAgent;
        }

        // =================================================================
        // DJ Booth Functions
        // =================================================================

        let currentCompiledPrompt = null;
        let currentAudioFile = null;

        // Load presets on page load
        async function loadDJPresets() {
            try {
                const res = await fetch('/api/suno/presets');
                const data = await res.json();
                const select = document.getElementById('dj-preset-select');
                select.innerHTML = '<option value="">Select Preset...</option>';
                (data.presets || []).forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name.replace(/_/g, ' ');
                    select.appendChild(opt);
                });
            } catch(e) {
                console.error('Failed to load presets:', e);
            }
        }

        // Preset selection handler
        document.getElementById('dj-preset-select').addEventListener('change', async function() {
            if (!this.value) return;
            try {
                const res = await fetch(`/api/suno/presets/${this.value}`);
                const data = await res.json();
                if (data.config) {
                    document.getElementById('dj-intent').value = data.config.intent || '';
                    document.getElementById('dj-mood').value = data.config.mood || 'mystical';
                    document.getElementById('dj-purpose').value = data.config.purpose || 'sfx';
                    document.getElementById('dj-weirdness').value = data.config.weirdness || 50;
                    document.getElementById('dj-style').value = data.config.style_balance || 50;
                    updateDJStatus('Preset loaded: ' + this.value);
                }
            } catch(e) {
                updateDJStatus('Failed to load preset');
            }
        });

        // Compile prompt
        async function compilePrompt() {
            const intent = document.getElementById('dj-intent').value;
            if (!intent) {
                updateDJStatus('Enter a sound description first');
                return;
            }

            updateDJStatus('Compiling...');
            try {
                const res = await fetch('/api/suno/compile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        intent: intent,
                        mood: document.getElementById('dj-mood').value,
                        purpose: document.getElementById('dj-purpose').value,
                        weirdness: parseInt(document.getElementById('dj-weirdness').value),
                        style_balance: parseInt(document.getElementById('dj-style').value),
                        instrumental: true
                    })
                });
                const data = await res.json();
                currentCompiledPrompt = data;

                // Show preview
                const preview = document.getElementById('dj-preview');
                const previewText = document.getElementById('dj-preview-text');
                preview.style.display = 'block';
                previewText.textContent = data.display || data.prompt?.substring(0, 200) + '...';

                updateDJStatus('Prompt compiled! Ready to generate.');
                addLogEntry('complete', 'DJ', 'suno_compile', intent.substring(0, 30) + '...');

            } catch(e) {
                console.error('Compile error:', e);
                updateDJStatus('Compile failed: ' + e.message);
            }
        }

        // Generate music
        async function generateMusic() {
            if (!currentCompiledPrompt || !currentCompiledPrompt.music_generate_args) {
                updateDJStatus('Compile a prompt first');
                return;
            }

            const btn = document.getElementById('dj-generate-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            updateDJStatus('Generating music... (2-4 min)');

            try {
                // Call music_generate tool via API
                const args = currentCompiledPrompt.music_generate_args;
                const res = await fetch('/api/tools/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tool: 'music_generate',
                        arguments: {
                            prompt: args.prompt,
                            style: args.style,
                            title: args.title,
                            model: args.model || 'V5',
                            is_instrumental: args.is_instrumental !== false,
                            blocking: true
                        }
                    })
                });
                const data = await res.json();

                if (data.result && data.result.status === 'complete') {
                    const files = data.result.files || [];
                    if (files.length > 0) {
                        currentAudioFile = files[0];
                        showAudioPlayer(currentAudioFile);
                        updateDJStatus('Generated! ' + files.length + ' track(s)');
                        addLogEntry('complete', 'DJ', 'music_generate', args.title);
                    }
                } else {
                    updateDJStatus('Generation failed: ' + (data.result?.error || 'Unknown error'));
                }

            } catch(e) {
                console.error('Generate error:', e);
                updateDJStatus('Generate failed: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üéπ Generate';
            }
        }

        // Show audio player
        function showAudioPlayer(filePath) {
            const container = document.getElementById('dj-audio-container');
            const player = document.getElementById('dj-audio-player');

            // Convert file path to static URL
            const fileName = filePath.split('/').pop();
            player.src = `/static/music/${fileName}`;
            container.style.display = 'block';
        }

        // Audio editing shortcuts
        async function editAudio(action) {
            if (!currentAudioFile) {
                updateDJStatus('No audio to edit');
                return;
            }

            updateDJStatus(`Applying ${action}...`);
            try {
                let endpoint, body;
                switch(action) {
                    case 'trim':
                        endpoint = '/api/audio/sfx-pipeline';
                        body = { file_path: currentAudioFile, duration: 5.0 };
                        break;
                    case 'fade':
                        endpoint = '/api/audio/fade';
                        body = { file_path: currentAudioFile, fade_in_ms: 100, fade_out_ms: 500 };
                        break;
                    case 'normalize':
                        endpoint = '/api/audio/normalize';
                        body = { file_path: currentAudioFile, target_dbfs: -14.0 };
                        break;
                }

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (data.output_file) {
                    currentAudioFile = data.output_file;
                    showAudioPlayer(currentAudioFile);
                    updateDJStatus(`${action} applied!`);
                    addLogEntry('complete', 'DJ', `audio_${action}`, 'OK');
                } else {
                    updateDJStatus(`${action} failed`);
                }
            } catch(e) {
                updateDJStatus(`${action} error: ` + e.message);
            }
        }

        // Update DJ status display
        function updateDJStatus(msg) {
            document.getElementById('dj-status').textContent = msg;
        }

        // =================================================================
        // Sound Control Functions
        // =================================================================

        function updateVolume(category, value) {
            if (!window.soundManager) return;
            const vol = value / 100;
            if (category === 'master') {
                window.soundManager.setMasterVolume(vol);
            } else {
                window.soundManager.setCategoryVolume(category, vol);
            }
        }

        function toggleMute() {
            if (!window.soundManager) return;
            const muted = window.soundManager.toggleMute();
            document.getElementById('mute-btn').textContent = muted ? 'üîá' : 'üîä';
        }

        // Initialize sound controls from saved settings
        function initSoundControls() {
            if (!window.soundManager) return;
            const status = window.soundManager.getStatus();
            document.getElementById('sound-master').value = status.masterVolume * 100;
            document.getElementById('sound-ui').value = (status.categoryVolumes.ui || 1) * 100;
            document.getElementById('sound-ambient').value = (status.categoryVolumes.ambient || 0.5) * 100;
            document.getElementById('mute-btn').textContent = status.muted ? 'üîá' : 'üîä';
        }

        // Load presets on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDJPresets();
            // Init sound controls after a short delay (wait for soundManager)
            setTimeout(initSoundControls, 1000);
        });
    </script>
    <script type="module" src="village.js"></script>
    <script>
        // Debug: Check if JS modules load correctly
        window.addEventListener('error', function(e) {
            console.error('JS Error:', e.message, e.filename, e.lineno);
            document.getElementById('stat-connection').textContent = 'JS ERROR: ' + e.message;
        });
        // Mark that inline script ran
        console.log('Village GUI: Inline scripts loaded');
    </script>
</body>
</html>
