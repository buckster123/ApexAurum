<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village GUI - Apex Aurum</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <a href="/" class="back-link">‚óÇ Back to Chat</a>

    <div class="village-layout">
        <!-- Left Panel: Agent Selection & Controls -->
        <aside class="control-panel">
            <div class="panel-section">
                <h3>‚öó Agent</h3>
                <select id="agent-select">
                    <option value="CLAUDE" data-color="#00aaff">CLAUDE (Default)</option>
                    <option value="AZOTH" data-color="#00ffaa">‚à¥AZOTH‚à¥</option>
                    <option value="ELYSIAN" data-color="#ff69b4">‚à¥ELYSIAN‚à¥</option>
                    <option value="VAJRA" data-color="#ffd700">‚à¥VAJRA‚à¥</option>
                    <option value="KETHER" data-color="#9370db">‚à¥KETHER‚à¥</option>
                </select>
            </div>

            <div class="panel-section">
                <h3>üõ† Quick Tools</h3>
                <div class="tool-buttons">
                    <button onclick="triggerTool('memory_list', {})" class="tool-btn memory">
                        üåø Memory
                    </button>
                    <button onclick="triggerTool('fs_list_files', {path: '.'})" class="tool-btn files">
                        üìÅ Files
                    </button>
                    <button onclick="triggerTool('get_current_time', {format: 'human'})" class="tool-btn time">
                        ‚è∞ Time
                    </button>
                    <button onclick="triggerTool('agent_list', {})" class="tool-btn agents">
                        üåâ Agents
                    </button>
                    <button onclick="triggerTool('execute_python', {code: 'print(\"Hello Village!\")'})" class="tool-btn code">
                        ‚öôÔ∏è Code
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <h3>üìä Stats</h3>
                <div id="stats-panel">
                    <div class="stat-row">
                        <span class="stat-label">Status:</span>
                        <span id="stat-connection" class="stat-value disconnected">‚óè</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Events:</span>
                        <span id="stat-events" class="stat-value">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Last Tool:</span>
                        <span id="stat-last-tool" class="stat-value">-</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center: Canvas -->
        <main class="canvas-container">
            <canvas id="village-canvas"></canvas>
        </main>

        <!-- Right Panel: Activity Log -->
        <aside class="activity-panel">
            <div class="panel-header">
                <h3>üìú Activity Log</h3>
                <button onclick="clearLog()" class="clear-btn" title="Clear log">‚úï</button>
            </div>
            <div id="activity-log">
                <div class="log-entry system">Waiting for events...</div>
            </div>
        </aside>
    </div>

    <script>
        // Global reference for village app (set by village.js)
        window.villageApp = null;

        // Trigger a tool and update UI
        async function triggerTool(tool, args) {
            const btn = event.target;
            btn.disabled = true;
            btn.classList.add('loading');

            try {
                const res = await fetch('/api/tools/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tool, arguments: args})
                });
                const data = await res.json();
                console.log('Tool result:', data);
            } catch(e) {
                console.error('Tool error:', e);
                addLogEntry('error', 'SYSTEM', tool, 'Request failed');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        // Add entry to activity log
        function addLogEntry(type, agent, tool, detail, zone = null) {
            const log = document.getElementById('activity-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            const icon = type === 'start' ? '‚Üí' : type === 'complete' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ä¢';
            const zoneText = zone ? ` @ ${zone}` : '';

            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-icon">${icon}</span>
                <span class="log-agent">${agent}</span>
                <span class="log-tool">${tool}</span>
                <span class="log-zone">${zoneText}</span>
            `;

            // Remove "waiting" message if present
            const waiting = log.querySelector('.system');
            if (waiting) waiting.remove();

            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;

            // Flash effect
            entry.classList.add('flash');
            setTimeout(() => entry.classList.remove('flash'), 500);
        }

        // Clear activity log
        function clearLog() {
            const log = document.getElementById('activity-log');
            log.innerHTML = '<div class="log-entry system">Log cleared</div>';
        }

        // Update stats display
        function updateStats(stats) {
            const conn = document.getElementById('stat-connection');
            conn.textContent = stats.connection === 'connected' ? '‚óè Connected' : '‚óã Disconnected';
            conn.className = 'stat-value ' + stats.connection;

            document.getElementById('stat-events').textContent = stats.eventCount;
            document.getElementById('stat-last-tool').textContent = stats.lastTool || '-';
        }

        // Agent selector change
        document.getElementById('agent-select').addEventListener('change', function() {
            const agentId = this.value;
            console.log('Switched to agent:', agentId);
            // Notify village app
            if (window.villageApp) {
                window.villageApp.setCurrentAgent(agentId);
            }
            // Store preference
            localStorage.setItem('village_agent', agentId);
        });

        // Restore agent preference
        const savedAgent = localStorage.getItem('village_agent');
        if (savedAgent) {
            document.getElementById('agent-select').value = savedAgent;
        }
    </script>
    <script type="module" src="village.js"></script>
</body>
</html>
